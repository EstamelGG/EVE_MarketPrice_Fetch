name: Fetch Market Prices

on:
  schedule:
    # 每60分钟执行一次（每小时的第0分钟）
    - cron: '50 * * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  fetch-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Run fetch script
      id: fetch
      run: |
        python fetch_market_prices.py
        script_exit=$?
        echo "exit_code=$script_exit" >> $GITHUB_OUTPUT
        exit $script_exit
      continue-on-error: true

    - name: Fail on real API fault
      if: steps.fetch.outputs.exit_code == '1'
      run: |
        echo "数据接口失败且 ESI 状态正常(players>0)，判定为真实故障"
        exit 1

    - name: Skip release when maintenance
      if: steps.fetch.outputs.exit_code == '2'
      run: |
        echo "ESI 维护中或不可用，跳过本次发布"

    - name: Delete old releases and tags
      if: steps.fetch.outputs.exit_code == '0'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 获取所有releases的ID
        releases=$(gh api repos/${{ github.repository }}/releases --jq '.[].id' || echo "")
        
        # 删除所有旧releases
        if [ -n "$releases" ]; then
          for release_id in $releases; do
            echo "Deleting release ID: $release_id"
            gh api repos/${{ github.repository }}/releases/$release_id -X DELETE || true
          done
          echo "所有旧releases已删除"
        else
          echo "没有找到旧的releases"
        fi
        
        # 删除market-prices tag（如果存在）
        echo "尝试删除旧的market-prices tag"
        gh api -X DELETE repos/${{ github.repository }}/git/refs/tags/market-prices 2>/dev/null && echo "market-prices tag已删除" || echo "market-prices tag不存在，跳过删除"
    
    - name: Create new release
      if: steps.fetch.outputs.exit_code == '0'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 使用固定的release名称
        RELEASE_NAME="market-prices"
        RELEASE_TITLE="Market Prices - $(date +'%Y-%m-%d %H:%M:%S')"
        
        # 创建新的release并上传文件
        gh release create "$RELEASE_NAME" \
          --title "$RELEASE_TITLE" \
          --notes "自动生成的市场价格数据" \
          output/market_prices.json
        
        echo "Release已更新: $RELEASE_NAME"

